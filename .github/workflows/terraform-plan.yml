name: terraform-plan

on:
  workflow_call:
    inputs:
      directory:
        description: >
          Path to the directory containing Terraform configuration.
          Defaults to ./terraform.
        required: false
        type: string
        default: "./terraform"
      extra_args:
        description: >
          Extra arguments to pass to the 'terraform plan' command.
          Useful for (dynamically) injecting variable files or flags.
        required: false
        type: string
        default: ""
      extra_init_args:
        description: >
          Extra arguments to pass to the 'terraform init' command.
        required: false
        type: string
        default: "-lockfile=readonly"
      terraform_version:
        description: >
          The version of Terraform to install and use.
        required: false
        type: string
        default: "1.12.2"
      encrypted_artifact_name:
        description: >
          Name of the encrypted artifact to download. The artifact must contain a single file named `archive.tar.age` created by the upload-encrypted-artifact action.
        required: false
        type: string
        default: ""
      runs-on:
        description: >
          The type of runner to use for the workflow. Defaults to 'ubuntu-latest'.
          You can specify a different runner if needed.
        required: false
        type: string
        default: "ubuntu-latest"
      debug:
        description: >
          Enable debug mode for more verbose logging. Defaults to false.
        required: false
        type: boolean
        default: false
    outputs:
      plan_outcome:
        description: |
          The outcome of the Terraform plan step, which can be used to determine if the plan was successful or not.
        value: ${{ jobs.plan.outputs.plan_outcome }}
      plan_output:
        description: |
          The output of the Terraform plan command.
        value: ${{ jobs.plan.outputs.plan_output }}

    secrets:
      AWS_ACCESS_KEY_ID:
        description: >
          AWS access key for authenticating with Terraform providers.
        required: true
      AWS_SECRET_ACCESS_KEY:
        description: >
          AWS secret key for authenticating with Terraform providers.
        required: true
      ARTIFACT_IDENTITY:
        description: >
          age identity (private key) used to decrypt the encrypted artifact (full contents starting with '# created:' and containing 'AGE-SECRET-KEY-'). Use the matching recipient public key when uploading.
        required: false
      GITHUB_APP_ID:
        description: >
          GitHub App ID used by Terraform to authenticate with the GitHub API and for commenting on PRs.
        required: true
      GITHUB_APP_INSTALLATION_ID:
        description: >
          GitHub App Installation ID used by Terraform to authenticate with the GitHub API and for commenting on PRs.
        required: true
      GITHUB_APP_PEM_FILE:
        description: >
          GitHub App private key (PEM format) used by Terraform to authenticate with the GitHub API and for commenting on PRs.
        required: true

jobs:
  plan:
    name: terraform-plan
    runs-on: ${{ inputs.runs-on }}

    outputs:
      plan_outcome: ${{ steps.terraform-plan.outputs.plan_outcome }}
      plan_output: ${{ steps.terraform-plan.outputs.plan_output }}

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GITHUB_APP_ID: ${{ secrets.GITHUB_APP_ID }}
      GITHUB_APP_INSTALLATION_ID: ${{ secrets.GITHUB_APP_INSTALLATION_ID }}
      GITHUB_APP_PEM_FILE: ${{ secrets.GITHUB_APP_PEM_FILE }}

    steps:
    - name: Terraform Plan
      id: terraform-plan
      uses: ./terraform-plan
      with:
        directory: ${{ inputs.directory }}
        extra_args: ${{ inputs.extra_args }}
        extra_init_args: ${{ inputs.extra_init_args }}
        terraform_version: ${{ inputs.terraform_version }}
        encrypted_artifact_name: ${{ inputs.encrypted_artifact_name }}
        artifact_identity: ${{ secrets.ARTIFACT_IDENTITY }}
        debug: ${{ inputs.debug }}
        github_app_id: ${{ secrets.GITHUB_APP_ID }}
        github_app_installation_id: ${{ secrets.GITHUB_APP_INSTALLATION_ID }}
        github_app_pem_file: ${{ secrets.GITHUB_APP_PEM_FILE }}
