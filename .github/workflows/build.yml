name: build

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

jobs:
  test-plan-reusable-workflow:
    uses: ./.github/workflows/terraform-plan.yml
    with:
      directory: ./test/terraform
      terraform_version: "1.14.6"
      runs-on: kubernetes-runner
      debug: true
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GITHUB_APP_ID: "1552622"
      GITHUB_APP_INSTALLATION_ID: "74918728"
      GITHUB_APP_PEM_FILE: ${{ secrets.GH_APP_PEM_FILE }}

  verify-test-plan-reusable-workflow:
    runs-on: kubernetes-runner
    needs: test-plan-reusable-workflow
    steps:
    - name: verify-terraform-plan
      run: |
        if [ "${{ needs.test-plan-reusable-workflow.outputs.plan_outcome }}" != "success" ]; then
          echo "Terraform plan failed."
          exit 1
        fi
        echo "Terraform plan succeeded."
        echo "${{ needs.test-plan-reusable-workflow.outputs.plan_output }}"

  test-apply-reusable-workflow:
    uses: ./.github/workflows/terraform-apply.yml
    with:
      directory: ./test/terraform
      terraform_version: "1.14.6"
      environment: ''
      runs-on: kubernetes-runner
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GITHUB_APP_ID: "1552622"
      GITHUB_APP_INSTALLATION_ID: "74918728"
      GITHUB_APP_PEM_FILE: ${{ secrets.GH_APP_PEM_FILE }}

  verify-test-apply-reusable-workflow:
    runs-on: kubernetes-runner
    needs: test-apply-reusable-workflow
    steps:
    - name: verify-terraform-apply
      run: |
        if [ "${{ needs.test-apply-reusable-workflow.outputs.apply_outcome }}" != "success" ]; then
          echo "Terraform apply failed."
          exit 1
        fi
        echo "Terraform apply succeeded."
        echo "${{ needs.test-apply-reusable-workflow.outputs.apply_output }}"

  test-plan:
    runs-on: kubernetes-runner
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    outputs:
      plan_outcome: ${{ steps.plan.outputs.plan_outcome }}
      plan_output: ${{ steps.plan.outputs.plan_output }}
    steps:
    - name: Checkout Repo
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Test plan
      id: plan
      uses: ./plan
      with:
        directory: ./test/terraform
        terraform_version: "1.14.6"
        debug: true
        github_app_id: "1552622"
        github_app_installation_id: "74918728"
        github_app_pem_file: ${{ secrets.GH_APP_PEM_FILE }}

  verify-test-plan:
    runs-on: kubernetes-runner
    needs: test-plan
    steps:
    - name: Verify plan outcome
      run: |
        if [ "${{ needs.test-plan.outputs.plan_outcome }}" != "success" ]; then
          echo "plan failed."
          exit 1
        fi
        echo "plan succeeded."
        echo "${{ needs.test-plan.outputs.plan_output }}"

  test-plan-for-apply-and-apply:
    runs-on: kubernetes-runner
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    outputs:
      plan_artifact_name: ${{ steps.plan.outputs.plan_artifact_name }}
      plan_outcome: ${{ steps.plan.outputs.plan_outcome }}
      apply_outcome: ${{ steps.apply.outputs.apply_outcome }}
    steps:
    - name: Checkout Repo
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Test plan-for-apply
      id: plan
      uses: ./plan-for-apply
      with:
        directory: ./test/terraform
        terraform_version: "1.14.6"
        debug: true
    - name: Verify plan artifact name output
      run: |
        if [ -z "${{ steps.plan.outputs.plan_artifact_name }}" ]; then
          echo "plan_artifact_name output is empty"
          exit 1
        fi
        echo "plan_artifact_name: ${{ steps.plan.outputs.plan_artifact_name }}"
    - name: Test apply
      id: apply
      uses: ./apply
      with:
        directory: ./test/terraform
        terraform_version: "1.14.6"
        plan_artifact_name: ${{ steps.plan.outputs.plan_artifact_name }}
        debug: true

  verify-plan-for-apply-and-apply:
    runs-on: kubernetes-runner
    needs: test-plan-for-apply-and-apply
    steps:
    - name: Verify plan-for-apply outcome
      run: |
        if [ "${{ needs.test-plan-for-apply-and-apply.outputs.plan_outcome }}" != "success" ]; then
          echo "plan-for-apply failed."
          exit 1
        fi
        echo "plan-for-apply succeeded."
    - name: Verify apply outcome
      run: |
        if [ "${{ needs.test-plan-for-apply-and-apply.outputs.apply_outcome }}" != "success" ]; then
          echo "apply failed."
          exit 1
        fi
        echo "apply succeeded."

  test-encrypted-artifact-upload-download:
    runs-on: kubernetes-runner
    steps:
    - name: Checkout Repo
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Setup age
      uses: alessiodionisi/setup-age-action@82b9aea163ade7fe23441552a514cf666b214077 # v1.3.0
    - name: Prepare plaintext and age key pair
      id: age-keys
      run: |
        set -euo pipefail
        cat > plain.txt << 'EOF'
        sample: secret
        answer: 42
        EOF
        # Generate age identity and capture public recipient key
        AGE_OUTPUT="$(age-keygen 2>&1)"
        echo "$AGE_OUTPUT" > identity.txt
        RECIPIENT=$(echo "$AGE_OUTPUT" | sed -n 's/^# public key: //p')
        if [ -z "$RECIPIENT" ]; then
          echo "Failed to extract age recipient public key" >&2
          exit 1
        fi
        echo "recipient=$RECIPIENT" >> $GITHUB_OUTPUT
        echo "identity=$(echo "$AGE_OUTPUT" | grep '^AGE-SECRET-KEY')" >> $GITHUB_OUTPUT
    - name: Upload encrypted artifact (age)
      id: enc
      uses: ./upload-encrypted-artifact
      with:
        artifact_name: test-artifact
        paths: plain.txt
        recipient: ${{ steps.age-keys.outputs.recipient }}
    - name: Decrypt encrypted artifact (age)
      uses: ./download-encrypted-artifact
      with:
        artifact_name: test-artifact
        out_dir: download
        identity: ${{ steps.age-keys.outputs.identity }}
    - name: list decrypted files
      run: ls -l download
    - name: Verify decrypted equals original
      run: diff -u plain.txt download/plain.txt

  check-workflow-status:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      actions: read
    steps:
    - name: Check Workflow Status
      id: check-workflow-status
      uses: eidp/actions-common/check-workflow-status@840f06eef3976bf54c702de638e290ea6be9273e # v1.3.4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
