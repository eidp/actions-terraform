name: build

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

jobs:
  plan:
    uses: ./.github/workflows/terraform-plan.yml
    with:
      directory: ./test/terraform
      terraform_version: "1.12.2"
      runs-on: kubernetes-runner
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GITHUB_APP_ID: "1552622"
      GITHUB_APP_INSTALLATION_ID: "74918728"
      GITHUB_APP_PEM_FILE: ${{ secrets.GH_APP_PEM_FILE }}

  verify-plan:
    runs-on: kubernetes-runner
    needs: plan
    steps:
    - name: verify-terraform-plan
      run: |
        if [ "${{ needs.plan.outputs.plan_outcome }}" != "success" ]; then
          echo "Terraform plan failed."
          exit 1
        fi
        echo "Terraform plan succeeded."
        echo "${{ needs.plan.outputs.plan_output }}"

  apply:
    uses: ./.github/workflows/terraform-apply.yml
    with:
      directory: ./test/terraform
      terraform_version: "1.12.2"
      environment: ''
      runs-on: kubernetes-runner
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GITHUB_APP_ID: "1552622"
      GITHUB_APP_INSTALLATION_ID: "74918728"
      GITHUB_APP_PEM_FILE: ${{ secrets.GH_APP_PEM_FILE }}

  verify-apply:
    runs-on: kubernetes-runner
    needs: apply
    steps:
    - name: verify-terraform-apply
      run: |
        if [ "${{ needs.apply.outputs.apply_outcome }}" != "success" ]; then
          echo "Terraform apply failed."
          exit 1
        fi
        echo "Terraform apply succeeded."
        echo "${{ needs.apply.outputs.apply_output }}"

  check-workflow-status:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      actions: read
    steps:
    - name: Check Workflow Status
      id: check-workflow-status
      uses: eidp/actions-common/check-workflow-status@v0
      with:
        jobs: 'plan / terraform-plan,verify-plan,apply / terraform-apply,verify-apply'
        github-token: ${{ secrets.GITHUB_TOKEN }}
