name: build

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

jobs:
  plan:
    uses: ./.github/workflows/terraform-plan.yml
    with:
      directory: ./test/terraform
      terraform_version: "1.12.2"
      runs-on: kubernetes-runner
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GITHUB_APP_ID: "1552622"
      GITHUB_APP_INSTALLATION_ID: "74918728"
      GITHUB_APP_PEM_FILE: ${{ secrets.GH_APP_PEM_FILE }}

  verify-plan:
    runs-on: kubernetes-runner
    needs: plan
    steps:
    - name: verify-terraform-plan
      run: |
        if [ "${{ needs.plan.outputs.plan_outcome }}" != "success" ]; then
          echo "Terraform plan failed."
          exit 1
        fi
        echo "Terraform plan succeeded."
        echo "${{ needs.plan.outputs.plan_output }}"

  apply:
    uses: ./.github/workflows/terraform-apply.yml
    with:
      directory: ./test/terraform
      terraform_version: "1.12.2"
      environment: ''
      runs-on: kubernetes-runner
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GITHUB_APP_ID: "1552622"
      GITHUB_APP_INSTALLATION_ID: "74918728"
      GITHUB_APP_PEM_FILE: ${{ secrets.GH_APP_PEM_FILE }}

  verify-apply:
    runs-on: kubernetes-runner
    needs: apply
    steps:
    - name: verify-terraform-apply
      run: |
        if [ "${{ needs.apply.outputs.apply_outcome }}" != "success" ]; then
          echo "Terraform apply failed."
          exit 1
        fi
        echo "Terraform apply succeeded."
        echo "${{ needs.apply.outputs.apply_output }}"

  test-encrypted-artifact-upload-download:
    runs-on: kubernetes-runner
    steps:
    - name: Checkout Repo
      uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
    - name: Prepare plaintext and key
      id: prep
      run: |
        mkdir -p tmp/upload tmp/download
        cat > tmp/upload/plain.txt << 'EOF'
        sample: secret
        answer: 42
        EOF
        echo "KEY=$(openssl rand -hex 16)" >> $GITHUB_ENV
        ls -la tmp/upload/
    - name: Encrypt credential file
      id: enc
      uses: ./upload-encrypted-artifact
      with:
        artifact_name: test-artifact
        paths: tmp/upload/plain.txt
        key: ${{ env.KEY }}
    - name: Decrypt credential file
      uses: ./download-encrypted-artifact
      with:
        artifact_name: test-artifact
        out_dir: tmp/download
        key: ${{ env.KEY }}
    - name: list decrypted files
      run: ls -l tmp/download/
    - name: Verify decrypted equals original
      run: diff -u tmp/upload/plain.txt tmp/download/plain.txt

  check-workflow-status:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      actions: read
    steps:
    - name: Check Workflow Status
      id: check-workflow-status
      uses: eidp/actions-common/check-workflow-status@1d37ef097c48440e0d87e70b0849bfa1b09cc961 # v0
      with:
        jobs: 'plan / terraform-plan,verify-plan,apply / terraform-apply,verify-apply,test-encrypted-artifact-upload-downloadt'
        github-token: ${{ secrets.GITHUB_TOKEN }}
