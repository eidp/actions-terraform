name: terraform-apply

on:
  workflow_call:
    inputs:
      directory:
        description: >
          Path to the directory containing Terraform configuration.
          Defaults to ./terraform.
        required: false
        type: string
        default: "./terraform"
      environment:
        description: >
          The environment to use for the Terraform apply step.
          This can be used to set up extra approval before applying changes.
        required: false
        type: string
        default: "github"
      extra_init_args:
        description: >
          Extra arguments to pass to the 'terraform init' command.
        required: false
        type: string
        default: "-lockfile=readonly"
      extra_args:
        description: >
          Extra arguments to pass to the 'terraform plan' and 'terraform apply' commands.
          Useful for (dynamically) injecting variable files or flags.
        required: false
        type: string
        default: ""
      terraform_version:
        description: >
          The version of Terraform to install and use.
        required: false
        type: string
        default: "1.14.0"
      encrypted_artifact_name:
        description: >
          Name of the encrypted artifact to download. The artifact must contain a single file named `archive.tar.age` created by the upload-encrypted-artifact action.
        required: false
        type: string
        default: ""
      runs-on:
        description: >
          The type of runner to use for the workflow. Defaults to 'ubuntu-latest'.
          You can specify a different runner if needed.
        required: false
        type: string
        default: "ubuntu-latest"
      debug:
        description: >
          Enable debug mode for more verbose logging. Defaults to false.
        required: false
        type: boolean
        default: false
      command_wrapper:
        description: >
          Optional command wrapper to prefix terraform commands with.
          Useful for credential injection tools like 1Password CLI (op run --)
          or AWS Vault (aws-vault exec profile --).
        required: false
        type: string
        default: ""

    secrets:
      AWS_ACCESS_KEY_ID:
        description: >
          AWS access key for authenticating with Terraform providers.
        required: true
      AWS_SECRET_ACCESS_KEY:
        description: >
          AWS secret key for authenticating with Terraform providers.
        required: true
      GITHUB_APP_ID:
        description: >
          GitHub App ID used by Terraform to authenticate with the GitHub API and for commenting on PRs.
        required: true
      GITHUB_APP_INSTALLATION_ID:
        description: >
          GitHub App Installation ID used by Terraform to authenticate with the GitHub API and for commenting on PRs.
        required: true
      GITHUB_APP_PEM_FILE:
        description: >
          GitHub App private key (PEM format) used by Terraform to authenticate with the GitHub API and for commenting on PRs.
        required: true
      ARTIFACT_IDENTITY:
        description: >
          age identity (private key) used to decrypt the encrypted artifact (full contents starting with '# created:' and containing 'AGE-SECRET-KEY-'). Use the matching recipient public key when uploading.
        required: false

    outputs:
      apply_outcome:
        description: |
          The status of the Terraform apply step, which can be used to determine if the apply was successful or not.
        value: ${{ jobs.apply.outputs.apply_outcome }}
      apply_output:
        description: |
          The output of the Terraform apply step.
        value: ${{ jobs.apply.outputs.apply_output }}

jobs:
  plan:
    name: terraform-plan
    runs-on: ${{ inputs.runs-on }}

    outputs:
      plan_artifact_name: ${{ steps.plan.outputs.plan_artifact_name }}

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
    - name: Terraform Plan
      id: plan
      uses: eidp/actions-terraform/plan-for-apply@a9e5ccf7cf0dabd583d76bacdbc10e438b291b81
      with:
        directory: ${{ inputs.directory }}
        extra_args: ${{ inputs.extra_args }}
        extra_init_args: ${{ inputs.extra_init_args }}
        terraform_version: ${{ inputs.terraform_version }}
        encrypted_artifact_name: ${{ inputs.encrypted_artifact_name }}
        artifact_identity: ${{ secrets.ARTIFACT_IDENTITY }}
        debug: ${{ inputs.debug }}
        command_wrapper: ${{ inputs.command_wrapper }}

  apply:
    needs: [plan]
    name: terraform-apply
    runs-on: ${{ inputs.runs-on }}
    environment: ${{ inputs.environment }}
    concurrency: ${{ inputs.environment }}-apply

    outputs:
      apply_outcome: ${{ steps.apply.outputs.apply_outcome }}
      apply_output: ${{ steps.apply.outputs.apply_output }}

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
    - name: Terraform Apply
      id: apply
      uses: eidp/actions-terraform/apply@a9e5ccf7cf0dabd583d76bacdbc10e438b291b81
      with:
        directory: ${{ inputs.directory }}
        extra_args: ${{ inputs.extra_args }}
        extra_init_args: ${{ inputs.extra_init_args }}
        terraform_version: ${{ inputs.terraform_version }}
        encrypted_artifact_name: ${{ inputs.encrypted_artifact_name }}
        artifact_identity: ${{ secrets.ARTIFACT_IDENTITY }}
        debug: ${{ inputs.debug }}
        command_wrapper: ${{ inputs.command_wrapper }}
        plan_artifact_name: ${{ needs.plan.outputs.plan_artifact_name }}
