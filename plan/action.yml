name: terraform-plan
description: |
  Runs Terraform plan with formatting, validation, and PR commenting.

  This action performs a complete Terraform plan workflow including:
  - Repository checkout
  - GitHub App token generation for API access
  - Optional encrypted artifact download
  - Terraform init, fmt, validate, and plan
  - Automatic PR commenting with plan output

  AWS credentials should be set as environment variables by the calling workflow.

author: eidp
branding:
  icon: file-text
  color: purple

inputs:
  directory:
    description: >
      Path to the directory containing Terraform configuration.
      Defaults to ./terraform.
    required: false
    default: ./terraform
  extra_args:
    description: >
      Extra arguments to pass to the 'terraform plan' command.
      Useful for (dynamically) injecting variable files or flags.
    required: false
    default: ''
  extra_init_args:
    description: >
      Extra arguments to pass to the 'terraform init' command.
    required: false
    default: -lockfile=readonly
  terraform_version:
    description: >
      The version of Terraform to install and use.
    required: false
    default: '1.12.2'
  encrypted_artifact_name:
    description: >
      Name of the encrypted artifact to download. The artifact must contain
      a single file named `archive.tar.age` created by the upload-encrypted-artifact action.
    required: false
    default: ''
  artifact_identity:
    description: >
      age identity (private key) used to decrypt the encrypted artifact
      (full contents starting with '# created:' and containing 'AGE-SECRET-KEY-').
      Use the matching recipient public key when uploading.
    required: false
    default: ''
  debug:
    description: >
      Enable debug mode for more verbose logging. Defaults to false.
    required: false
    default: 'false'
  github_app_id:
    description: >
      GitHub App ID used by Terraform to authenticate with the GitHub API
      and for commenting on PRs.
    required: true
  github_app_installation_id:
    description: >
      GitHub App Installation ID used by Terraform to authenticate with
      the GitHub API and for commenting on PRs.
    required: true
  github_app_pem_file:
    description: >
      GitHub App private key (PEM format) used by Terraform to authenticate
      with the GitHub API and for commenting on PRs.
    required: true

outputs:
  plan_outcome:
    description: |
      The outcome of the Terraform plan step (success or failure).
    value: ${{ steps.plan.outcome }}
  plan_output:
    description: |
      The output of the Terraform plan command.
    value: ${{ steps.plan.outputs.stdout }}

runs:
  using: composite
  steps:
  - name: Checkout Repo
    uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

  - name: Generate App token
    id: generate-app-token
    uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
    with:
      app-id: ${{ inputs.github_app_id }}
      private-key: ${{ inputs.github_app_pem_file }}

  - name: Download encrypted artifact
    if: ${{ inputs.encrypted_artifact_name != '' }}
    uses: eidp/actions-terraform/download-encrypted-artifact@b98cb7878f82a41977fab8f6d387006017796e5f # v1.2.0
    with:
      artifact_name: ${{ inputs.encrypted_artifact_name }}
      identity: ${{ inputs.artifact_identity }}
      out_dir: './'

  - name: Setup Node
    uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
    with:
      node-version: '20.x'

  - name: Setup Terraform
    uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
    with:
      terraform_version: ${{ inputs.terraform_version }}

  - name: Terraform Init
    id: init
    shell: bash
    working-directory: ${{ inputs.directory }}
    run: terraform init ${{ inputs.extra_init_args }} -input=false

  - name: Terraform Format
    id: fmt
    shell: bash
    working-directory: ${{ inputs.directory }}
    run: terraform fmt -recursive -check

  - name: Terraform Validate
    id: validate
    shell: bash
    working-directory: ${{ inputs.directory }}
    run: terraform validate -no-color

  - name: Terraform Plan
    id: plan
    shell: bash
    working-directory: ${{ inputs.directory }}
    run: |
      set -o pipefail
      if [ "${{ inputs.debug }}" = "true" ]; then
        export TF_LOG=TRACE
        export TF_LOG_PATH=./terraform.log
      fi
      terraform plan -input=false -no-color ${{ inputs.extra_args }} -out=tfplan || PLAN_EXIT_CODE=$?
      terraform show -no-color tfplan

      if [ -f ./terraform.log ]; then
        echo "----- Terraform Debug Log -----"
        cat ./terraform.log
      fi

      exit ${PLAN_EXIT_CODE:-0}

  - name: Comment on PR
    id: add-pr-comment
    if: always()
    uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc # v2.8.2
    with:
      repo-token: ${{ steps.generate-app-token.outputs.token }}
      message-id: ${{ inputs.directory }}
      message: |
        ## Terraform Plan for Directory: `${{ inputs.directory }}`
        #### ğŸ–Œ **Terraform Format and Style:** `${{ steps.fmt.outcome }}`
        #### âš™ï¸ **Terraform Initialization:** `${{ steps.init.outcome }}`
        #### ğŸ¤– **Terraform Validation:**  `${{ steps.validate.outcome }}`
        #### ğŸ“– **Terraform Plan:** `${{ steps.plan.outcome }}`

        <details>
          <summary><b>ğŸ” Show Terraform Plan</b></summary>

          <blockquote>

        ```tf
        ${{ steps.plan.outputs.stdout }}
        ```

          </blockquote>
        </details>
      message-failure: |
        ## Terraform Plan for Directory: `${{ inputs.directory }}`

        **âŒ Terraform execution failed. Please review the errors below and fix the issues before proceeding.**

        #### ğŸ–Œ **Terraform Format and Style:** `${{ steps.fmt.outcome }}`
        #### âš™ï¸ **Terraform Initialization:** `${{ steps.init.outcome }}`
        #### ğŸ¤– **Terraform Validation:**  `${{ steps.validate.outcome }}`
        #### ğŸ“– **Terraform Plan:** `${{ steps.plan.outcome }}`

        ${{ steps.fmt.outcome == 'failure' && format('<details>
          <summary><b>ğŸ”´ Format Errors</b></summary>

          <blockquote>

        The following files are not properly formatted. Run `terraform fmt -recursive` to fix formatting issues:

        ```
        {0}
        ```

          </blockquote>
        </details>', steps.fmt.outputs.stdout) || '' }}

        ${{ steps.init.outcome == 'failure' && format('<details>
          <summary><b>ğŸ”´ Initialization Errors</b></summary>

          <blockquote>

        ```
        {0}
        ```

          </blockquote>
        </details>', steps.init.outputs.stderr) || '' }}

        ${{ steps.validate.outcome == 'failure' && format('<details>
          <summary><b>ğŸ”´ Validation Errors</b></summary>

          <blockquote>

        The Terraform configuration contains validation errors that must be fixed:

        ```
        {0}
        ```

          </blockquote>
        </details>', steps.validate.outputs.stderr) || '' }}

        ${{ steps.plan.outcome == 'failure' && steps.fmt.outcome != 'failure' && steps.init.outcome != 'failure' && steps.validate.outcome != 'failure' && format('<details>
          <summary><b>ğŸ”´ Plan Errors</b></summary>

          <blockquote>

        ```tf
        {0}
        ```

          </blockquote>
        </details>', steps.plan.outputs.stderr) || '' }}
